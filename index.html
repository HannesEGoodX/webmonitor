<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Website Status Monitor</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>Website Status Monitor</h1>

    <div
      id="last-updated-top"
      style="
        text-align: center;
        margin-bottom: 1.5rem;
        font-size: 0.9em;
        color: #666;
      "
    >
      Last updated: Loading...
    </div>

    <div class="monitor-button-container">
      <button id="monitorNowButton" class="monitor-button">Monitor Now</button>
    </div>

    <div id="sites-container">Loading status...</div>

    <script>
      // This is the correct path for Netlify Functions
      const SERVERLESS_TRIGGER_URL =
        "/.netlify/functions/trigger-github-workflow";

      async function loadStatus() {
        try {
          const res = await fetch("status.json?" + new Date().getTime()); // prevent cache
          if (!res.ok) throw new Error("Failed to load status.json");

          const data = await res.json();

          const utcDateString = data.last_checked;
          const date = new Date(utcDateString.replace(" UTC", "Z"));

          const options = {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
            timeZone: "Africa/Johannesburg",
            timeZoneName: "shortOffset",
          };
          const sastTimeString = date.toLocaleString("en-ZA", options);

          document.getElementById(
            "last-updated-top"
          ).textContent = `Last updated: ${sastTimeString}`;

          const container = document.getElementById("sites-container");
          container.innerHTML = "";

          data.sites.forEach((site) => {
            const div = document.createElement("div");
            div.className = "site";

            const sslDaysLeft =
              site.ssl_days_left !== null
                ? ` (expires in ${site.ssl_days_left} days)`
                : "";

            const responseTime =
              site.response_time !== null
                ? `Response Time: ${site.response_time} s`
                : `Response Time: N/A`;

            let statusClass = "unknown-status";
            if (site.status === "online") {
              statusClass = "up";
            } else if (
              site.status === "offline" ||
              site.status.startsWith("error")
            ) {
              statusClass = "down";
            }

            div.innerHTML = `
                <h2><a href="${
                  site.url
                }" target="_blank" rel="noopener noreferrer">${
              site.url
            }</a></h2>
                <p>Status: <span class="${statusClass}">${
              site.status
            }</span></p>
                <p>SSL Certificate: <span class="${
                  site.ssl_status === "valid" ? "ssl-ok" : "ssl-expired"
                }">${site.ssl_status}${sslDaysLeft}</span></p>
                <p>${responseTime}</p>
            `;

            container.appendChild(div);
          });
        } catch (error) {
          document.getElementById("last-updated-top").textContent =
            "Last updated: Error loading...";
          document.getElementById("sites-container").textContent =
            "Error loading status.";
          console.error(error);
        }
      }

      // Function to trigger the GitHub Actions workflow via a serverless function
      async function triggerWorkflow() {
        document.getElementById("monitorNowButton").disabled = true; // Disable button during trigger
        document.getElementById("monitorNowButton").textContent =
          "Triggering check...";

        try {
          const response = await fetch(SERVERLESS_TRIGGER_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ action: "trigger_site_monitor" }),
          });

          if (response.ok) {
            alert(
              "New site check triggered! It may take a minute for the status to update on GitHub Pages. Refreshing data now."
            );
            // Give GitHub Actions a moment to run, then refresh the displayed data
            setTimeout(() => {
              loadStatus();
            }, 5000);
          } else {
            const errorText = await response.text();
            // Parse error text if it's JSON, otherwise display as is
            let errorMessage = errorText;
            try {
              const errorJson = JSON.parse(errorText);
              if (errorJson && errorJson.message) {
                errorMessage = errorJson.message;
              }
            } catch (e) {
              // Not JSON, use raw text
            }
            alert(
              `Failed to trigger check: ${errorMessage}. Please check serverless function logs.`
            );
          }
        } catch (error) {
          alert(`Error connecting to trigger service: ${error.message}`);
        } finally {
          document.getElementById("monitorNowButton").disabled = false;
          document.getElementById("monitorNowButton").textContent =
            "Monitor Now";
        }
      }

      // Initial load
      loadStatus();

      // Add event listener for the "Monitor Now" button
      document
        .getElementById("monitorNowButton")
        .addEventListener("click", triggerWorkflow);
    </script>
  </body>
</html>
